000 A 000
A
BILL_MONTH  = 201705  
CUR_MONTH   = 201706   
NEXT_MONTH1 = 201707 
NEXT_MONTH2 = 201708 
Timing is on.
CREATE LOCAL TEMP table OFR_MAIN_ASSET_A ON COMMIT PRESERVE ROWS
AS(
SELECT     P1.Asset_Row_Id 
           ,TO_DATE('20170608' ,  'YYYYMMDD') AS Start_Dt
           ,P1.Start_Dt AS Real_Start_Dt
           ,P1.Serv_Start_Dt
           ,P1.Serv_End_Dt
           ,P12.Std_Prd_Lvl4_Name
           ,P12.Std_Prd_Lvl3_Id
           ,P1.STD_PRD_LVL4_ID
           ,(CASE WHEN P1.Stat_Name IN ('现行','不活动','已暂停')
                   THEN P1.Stat_Name
                   ELSE 'err'
               END) AS  Stat_Name        
            ,(CASE WHEN P1.ODS_Stat_Name IN ('F0K','F0P') THEN '双向'       
									 WHEN P1.ODS_Stat_Name ='F0M' THEN '单向'
                   else 'err'
                    END  ) AS Owe_Suspend_Name             
            ,(CASE WHEN P1.Pre_Active_Status='预开户1' THEN '预开户'
                  WHEN P1.Pre_Active_Status='正常' THEN '正常开户'
                  ELSE P1.Pre_Active_Status
              END) AS Pre_Active_Status  
            ,P1.LATN_ID        
            ,P1.STAT_CHANGE_DT     
      FROM  BSSDATA_2.OFR_MAIN_ASSET_HIST_A   P1
INNER JOIN  DMN_2.CAG_COM_STD_PRD_LVL4                  P12
        ON  P1.Std_Prd_Lvl4_Id=P12.Std_Prd_Lvl4_Id
     WHERE  P1.Start_Dt<=TO_DATE('20170608' ,  'YYYYMMDD')
	     AND  P1.End_Dt  >TO_DATE('20170608' ,  'YYYYMMDD')
	     AND  P12.PRD_ID IN('40','60','50','10','70')   
	     
)
ORDER BY Asset_Row_Id, P1.STD_PRD_LVL4_ID
SEGMENTED BY HASH (Asset_Row_Id) ALL NODES KSAFE 0
;
CREATE TABLE
Time: First fetch (0 rows): 18761.383 ms. All rows formatted: 18761.419 ms
CREATE LOCAL TEMP table MAIN_FREE_CORP_PAY_A ON COMMIT PRESERVE ROWS
AS(
select   Asset_Row_Id
            ,MAX(CASE WHEN P.Cdsc_Row_Id='1-19849-1' THEN 1 ELSE 0 END) AS Test_Flg
      FROM  BSSDATA_2.OFR_ASSET_CDSC_HIST_A       P  
     WHERE  P.Stat_Name ='使用中'
       AND  P.Start_Dt<=TO_DATE('20170608' ,  'YYYYMMDD')
       AND  P.End_Dt>TO_DATE('20170608' ,  'YYYYMMDD')
       AND  P.Asset_Row_Id IN (SELECT Asset_Row_Id FROM OFR_MAIN_ASSET_A)
      GROUP BY Asset_Row_Id 
)
ORDER BY (Asset_Row_Id)
SEGMENTED BY HASH (Asset_Row_Id) ALL NODES KSAFE 0
;
CREATE TABLE
Time: First fetch (0 rows): 4550.142 ms. All rows formatted: 4550.166 ms
CREATE LOCAL TEMP table STOP_ASSET_A ON COMMIT PRESERVE ROWS
AS(
    SELECT  Asset_Row_Id
        		,MAX(CASE WHEN Call_Limit_Stat IN('F0K','F0P') THEN 1 else 0 END) AS Twoway_Stop_Flg   
    		    ,MAX(CASE WHEN Call_Limit_Stat='F0M' THEN 1 else 0 END) AS Oneway_Stop_Flg   
            ,MAX(CASE WHEN Call_Limit_Stat IN('F0K','F0P')                                         
                      THEN TO_DATE('19990101' ,  'YYYYMMDD')
                      ELSE TO_DATE(TO_CHAR(Deal_Time)  ,  'YYYYMMDD')
                  END ) AS Oneway_Stop_Dt
            ,MAX(CASE WHEN Call_Limit_Stat='F0M'                                         
                      THEN TO_DATE('19990101' ,  'YYYYMMDD')
                      ELSE TO_DATE(TO_CHAR(Deal_Time) ,  'YYYYMMDD')
                  END ) AS Twoway_Stop_Dt
      FROM  BSSDATA_2.OFR_ASSET_CALL_LIMIT_LOG_A
     WHERE  TO_DATE(TO_CHAR(Deal_Time)  ,  'YYYYMMDD')<=TO_DATE('20170608' ,  'YYYYMMDD')
       AND  Call_Limit_Stat IN('F0M','F0K','F0P')                                        
     GROUP BY Asset_Row_Id
)
ORDER BY (Asset_Row_Id)
SEGMENTED BY HASH (Asset_Row_Id) ALL NODES KSAFE 0
;
CREATE TABLE
Time: First fetch (0 rows): 2214.747 ms. All rows formatted: 2214.765 ms
CREATE LOCAL TEMP table STOP_ASSET_1_A ON COMMIT PRESERVE ROWS
AS(
    SELECT  Asset_Row_Id
        		,MAX(CASE WHEN Call_Limit_Stat IN('F0K','F0P') THEN 1 else 0 END) AS Twoway_Stop_Flg1      
    		    ,MAX(CASE WHEN Call_Limit_Stat='F0M' THEN 1 else 0 END) AS Oneway_Stop_Flg1                
            ,MAX(CASE WHEN Call_Limit_Stat IN('F0K','F0P')                                             
                      THEN TO_DATE('19990101' ,  'YYYYMMDD')
                      ELSE TO_DATE(TO_CHAR(Stat_Upd_Time) ,  'YYYYMMDD')
                  END ) AS Oneway_Stop_Dt1
            ,MAX(CASE WHEN Call_Limit_Stat='F0M' 
                      THEN TO_DATE('19990101' ,  'YYYYMMDD')
                      ELSE TO_DATE(TO_CHAR(Stat_Upd_Time) ,  'YYYYMMDD')
                  END ) AS Twoway_Stop_Dt1
      FROM  BSSDATA_2.OFR_ASSET_CALL_LIMIT_LOG_A
     WHERE  TO_DATE(TO_CHAR(Stat_Upd_Time) ,  'YYYYMMDD')<=TO_DATE('20170608' ,  'YYYYMMDD')
       AND  Deal_Time IS NULL
       AND  Call_Limit_Stat IN('F0M','F0K','F0P')
     GROUP BY Asset_Row_Id
)
ORDER BY (Asset_Row_Id)
SEGMENTED BY HASH (Asset_Row_Id) ALL NODES KSAFE 0
;
CREATE TABLE
Time: First fetch (0 rows): 264.587 ms. All rows formatted: 264.615 ms
CREATE LOCAL TEMP table OWE_92_A ON COMMIT PRESERVE ROWS
AS(
SELECT  p.Asset_Integ_Id            
            ,p1.ASSET_ROW_ID
            ,SUM(Amt)   Amt
     FROM  BSSDATA_2.FIN_PG_OWE_STMT_ITEM_D_A p
LEFT JOIN  BSSDATA_2.OFR_MAIN_ASSET_HIST_A P1
       ON  P.Asset_Integ_Id=P1.Asset_Integ_Id
      AND  P1.END_DT=DATE'3000-12-31'
    WHERE  Stmt_Dt <= TO_DATE('20170608' ,  'YYYYMMDD')- 91 
      AND  FLG='1'
  GROUP BY  p.Asset_Integ_Id
            ,p1.ASSET_ROW_ID
)
ORDER BY p.Asset_Integ_Id, Asset_Row_Id
SEGMENTED BY HASH (Asset_Row_Id) ALL NODES KSAFE 0
;
CREATE TABLE
Time: First fetch (0 rows): 6893.213 ms. All rows formatted: 6893.232 ms
CREATE LOCAL TEMP table MAIN_PRE_1_A ON COMMIT PRESERVE ROWS
AS(
SELECT       P1.Asset_Row_Id
              ,P1.Start_Dt
              ,P1.Stat_Name     
              ,P1.Serv_Start_Dt
              ,P1.Serv_End_Dt       
              ,P1.Owe_Suspend_Name
              ,P1.Pre_Active_Status
              ,P1.Std_Prd_Lvl4_Id
              ,P1.Std_Prd_Lvl4_Name
              ,P1.Std_Prd_Lvl3_Id 
              ,COALESCE(P18.Test_Flg,0) AS Test_Flg                   
             ,(CASE WHEN P1.Stat_Name='已暂停' AND P1.Owe_Suspend_Name='单向' 
                          THEN (CASE WHEN P34.Oneway_Stop_Flg = 1 AND P34.Oneway_Stop_Dt IS NOT NULL
                                    THEN P34.Oneway_Stop_Dt
                                    WHEN P33.Oneway_Stop_Dt1 IS NOT NULL AND P34.Oneway_Stop_Dt IS  NULL
                                    THEN P33.Oneway_Stop_Dt1
                                    ELSE P1.Real_Start_Dt
                                END)
                          ELSE NULL
                      END) AS Oneway_Stop_Dt                  
              ,(CASE WHEN P1.Stat_Name='已暂停' AND P1.Owe_Suspend_Name='双向' 
                          THEN (CASE WHEN P34.Twoway_Stop_Flg = 1 AND P34.Twoway_Stop_Dt IS NOT NULL
                                     THEN P34.Twoway_Stop_Dt
                                     WHEN P33.Twoway_Stop_Dt1 IS NOT NULL  AND P34.Twoway_Stop_Dt IS NULL
                                     THEN P33.Twoway_Stop_Dt1
                                     ELSE P1.Real_Start_Dt
                                END)
                          ELSE NULL
                      END) AS Twoway_Stop_Dt                    
             ,(CASE WHEN P34.Twoway_Stop_Flg = 1 AND P34.Twoway_Stop_Dt IS NOT NULL
                                     THEN P34.Twoway_Stop_Dt
                                     WHEN P33.Twoway_Stop_Dt1 IS NOT NULL  AND P34.Twoway_Stop_Dt IS NULL
                                     THEN P33.Twoway_Stop_Dt1
                                     ELSE NULL
                                END) AS Twoway_Stop_Dt1       
              ,(CASE WHEN P2.Asset_Row_Id IS NOT NULL AND P1.Std_Prd_Lvl4_Id IN (11010501) THEN 1 ELSE 0 END) AS Own_Flg
              ,P1.LATN_ID
        FROM  OFR_MAIN_ASSET_A                            P1
   LEFT JOIN  STOP_ASSET_A                           P34
          ON  P1.Asset_Row_Id=P34.Asset_Row_Id
   LEFT JOIN  STOP_ASSET_1_A                         P33
          ON  P1.Asset_Row_Id=P33.Asset_Row_Id       
   LEFT JOIN  MAIN_FREE_CORP_PAY_A                   P18
          ON  P1.Asset_Row_Id=P18.Asset_Row_Id
   LEFT JOIN  OWE_92_A              P2
          ON  P1.Asset_Row_Id = P2.Asset_Row_Id
         AND  P2.Amt > 0
)
ORDER BY (Asset_Row_Id)
SEGMENTED BY HASH (Asset_Row_Id) ALL NODES KSAFE 0
;
CREATE TABLE
Time: First fetch (0 rows): 19307.535 ms. All rows formatted: 19307.560 ms
CREATE LOCAL TEMP table MAIN_PRE_2_A ON COMMIT PRESERVE ROWS
AS(
SELECT  P1.*
                 ,(CASE WHEN P1.Std_Prd_Lvl4_Id IN (11010200,11010201,11010202,11010307) AND P20.Stat_Name IS NOT NULL AND P20.Stat_Name IN ('IPAS激活','CRM预占')     THEN '正常开户'
                        WHEN P1.Std_Prd_Lvl4_Id IN (11010200,11010201,11010202,11010307) AND P20.Stat_Name IS NOT NULL AND P20.Stat_Name NOT IN ('IPAS激活','CRM预占') THEN '预开户'
                        ELSE P1.Pre_Active_Status
                   END) AS Pre_Active_Status1
           FROM    MAIN_PRE_1_A                                 P1     
      LEFT JOIN   (SELECT  Asset_Row_Id
                          ,MIN(Stat_Name) AS Stat_Name
                    FROM  BSSDATA_2.OFR_ASSET_INST_STAT_HIST_A
                   WHERE  Asset_Row_Id IS NOT NULL
                     AND  Asset_Row_Id <> '-1'
                     AND  Start_Dt<=TO_DATE('20170608' ,  'YYYYMMDD')
                     AND  End_Dt>TO_DATE('20170608' ,  'YYYYMMDD')
                 GROUP BY Asset_Row_Id)                                              P20
             ON  	 P1.Asset_Row_Id=P20.Asset_Row_Id   
)
ORDER BY (Asset_Row_Id)
SEGMENTED BY HASH (Asset_Row_Id) ALL NODES KSAFE 0
;
CREATE TABLE
Time: First fetch (0 rows): 16638.854 ms. All rows formatted: 16638.873 ms
CREATE LOCAL TEMP table TMP_SPEED_A ON COMMIT PRESERVE ROWS
AS(
SELECT ASSET_ROW_ID,VAL FROM (							  
SELECT
						ROW_NUMBER() OVER (PARTITION BY P1.ASSET_ROW_ID ORDER BY CASE WHEN (P2.VAL IS NOT NULL AND P2.VAL <> '-1') THEN P2.Etl_Dt ELSE P1.Etl_Dt END DESC) AS Q_RANK
						,P1.ASSET_ROW_ID
						,CASE WHEN (P2.VAL IS NOT NULL AND P2.VAL <> '-1') THEN P2.VAL
									ELSE P1.VAL
						END VAL
FROM 				BSSDATA_2.OFR_ASSET_EXI_HIST_A P1
LEFT JOIN   BSSDATA_2.OFR_ASSET_EXI_HIST_A P2
ON					P1.ASSET_ROW_ID = P2.ASSET_ROW_ID
AND         P2.Start_Dt<=TO_DATE('20170608' ,  'YYYYMMDD')
AND         P2.End_Dt>TO_DATE('20170608' ,  'YYYYMMDD') 
AND         P2.VAL_TYPE_NAME = '使用速率'
WHERE				P1.Start_Dt<=TO_DATE('20170608' ,  'YYYYMMDD')
AND         P1.End_Dt>TO_DATE('20170608' ,  'YYYYMMDD') 
AND 				P1.VAL_TYPE_NAME = '下载速率'
) T WHERE Q_RANK   = 1
)
ORDER BY (Asset_Row_Id)
SEGMENTED BY HASH (Asset_Row_Id) ALL NODES KSAFE 0
;
CREATE TABLE
Time: First fetch (0 rows): 136.834 ms. All rows formatted: 136.849 ms
INSERT INTO TMP_SPEED_A
SELECT ASSET_ROW_ID,VAL FROM (							  
SELECT
						ROW_NUMBER() OVER (PARTITION BY P1.ASSET_ROW_ID ORDER BY CASE WHEN P1.VAL_TYPE_NAME = '速率' THEN 2
                                                                         WHEN P1.VAL_TYPE_NAME = '端口速率' THEN 1
                                                                    else 0 END DESC) AS Q_RANK
						,P1.ASSET_ROW_ID
						,CASE WHEN P1.VAL_TYPE_NAME = '速率' THEN P1.VAL
                  WHEN P1.VAL_TYPE_NAME = '端口速率' THEN P1.VAL
                ELSE 'ERR'
            END VAL
FROM 				BSSDATA_2.OFR_ASSET_EXI_HIST_A P1
INNER JOIN  MAIN_PRE_2_A P2
        ON  P1.ASSET_ROW_ID = P2.ASSET_ROW_ID
     WHERE	P1.Start_Dt<=TO_DATE('20170608' ,  'YYYYMMDD')
       AND  P1.End_Dt>TO_DATE('20170608' ,  'YYYYMMDD') 
       AND 	P1.VAL_TYPE_NAME IN ('速率','端口速率')
       AND  P2.STD_PRD_LVL4_ID IN(14030501,14030500)
) T WHERE Q_RANK     = 1       
;
 OUTPUT 
--------
      0
(1 row)

Time: First fetch (1 row): 86.304 ms. All rows formatted: 86.360 ms
CREATE LOCAL TEMP TABLE OWE_STMT_1_A  ON COMMIT PRESERVE ROWS
AS 
(select   					P1.ASSET_ROW_ID
                    ,P1.Owe_Stmt_Dt
                    ,P1.Stmt_Dt
                    ,SUM(P1.AMT) AS OWE_AMT      
             FROM   BSSDATA_2.FIN_PG_OWE_STMT_ITEM_D_A   P1
       INNER JOIN		OFR_MAIN_ASSET_A P2
       				 ON		P1.ASSET_ROW_ID = P2.ASSET_ROW_ID
       				AND   P2.STAT_NAME <> '不活动'
            WHERE   P1.FLG IN ('1','2')
              AND   P1.Bad_Debt_Flg = 'N'
   GROUP BY 1,2,3
)
ORDER BY (ASSET_ROW_ID)
SEGMENTED BY HASH (ASSET_ROW_ID) ALL NODES KSAFE 0;
CREATE TABLE
Time: First fetch (0 rows): 3778.396 ms. All rows formatted: 3778.418 ms
CREATE LOCAL TEMP table OWE_STMT_2_A ON COMMIT PRESERVE ROWS
AS 
(select             ASSET_ROW_ID
                    ,MAX(CAST(EXTRACT(YEAR FROM Owe_Stmt_Dt) - EXTRACT(YEAR FROM Stmt_Dt) AS INTEGER)*12+CAST(EXTRACT(MONTH FROM Owe_Stmt_Dt)-(EXTRACT(MONTH FROM Stmt_Dt)+1) AS INTEGER)) NBR
            FROM    OWE_STMT_1_A 
           WHERE    OWE_AMT > 0
           GROUP BY 1
)
ORDER BY (ASSET_ROW_ID)
SEGMENTED BY HASH (ASSET_ROW_ID) ALL NODES KSAFE 0;
CREATE TABLE
Time: First fetch (0 rows): 341.958 ms. All rows formatted: 341.977 ms
CREATE LOCAL TEMP TABLE NEW_BIL_FLG_A_3 ON COMMIT PRESERVE ROWS
AS
(
		SELECT
							P1.ASSET_ROW_ID
							,CASE WHEN P1.STAT_NAME = '不活动' THEN 0
										WHEN P1.Pre_Active_Status ='预开户' THEN 0
										WHEN P1.STD_PRD_LVL4_ID IN ('11020413','11020419') AND P1.STAT_NAME = '已暂停' AND P1.STAT_CHANGE_DT < TO_DATE ('20170608' ,  'YYYYMMDD')-31 THEN 0
										WHEN P1.STD_PRD_LVL4_ID NOT IN ('11020413','11020419') AND P2.ASSET_ROW_ID IS NOT NULL AND P2.NBR >= 3 THEN 0
										ELSE 1
							END AS BIL_FLG
			FROM		OFR_MAIN_ASSET_A P1
 LEFT JOIN		OWE_STMT_2_A P2
 				ON		P1.ASSET_ROW_ID = P2.ASSET_ROW_ID
)
ORDER BY (ASSET_ROW_ID)
SEGMENTED BY HASH (ASSET_ROW_ID) ALL NODES KSAFE 0
;
CREATE TABLE
Time: First fetch (0 rows): 9810.147 ms. All rows formatted: 9810.167 ms
CREATE LOCAL TEMP TABLE NEW_BIL_FLG_A ON COMMIT PRESERVE ROWS
AS
(
SELECT ASSET_ROW_ID,BIL_FLG FROM (								  
		SELECT
							ROW_NUMBER () OVER (PARTITION BY P1.ASSET_ROW_ID ORDER BY BIL_FLG) AS Q_RANK
							,P1.ASSET_ROW_ID					   
							,CASE WHEN P2.ASSET_ROW_ID IS NOT NULL THEN 0 ELSE P1.BIL_FLG END BIL_FLG
			FROM		NEW_BIL_FLG_A_3 P1 
 LEFT JOIN    BSSDATA_2.OFR_CHILD_ASSET_HIST_A P2
        ON    P1.ASSET_ROW_ID = P2.ROOT_ASSET_ROW_ID
       AND    P2.START_DT <= TO_DATE('20170608' ,  'YYYYMMDD')
       AND    P2.End_Dt > TO_DATE('20170608' ,  'YYYYMMDD')
       AND    P2.CPRD_ROW_ID = '1-HKOIMR0'
       AND    P2.STAT_NAME <> '不活动'
) T WHERE Q_RANK = 1
)
ORDER BY (ASSET_ROW_ID)
SEGMENTED BY HASH (ASSET_ROW_ID) ALL NODES KSAFE 0
;
CREATE TABLE
Time: First fetch (0 rows): 29945.438 ms. All rows formatted: 29945.460 ms
CREATE LOCAL TEMP table MAIN_PRE_A ON COMMIT PRESERVE ROWS
AS(
SELECT            P1.Asset_Row_Id
                 ,P1.Start_Dt AS Date_Cd
                 ,P1.Std_Prd_Lvl4_Name
                 ,P1.Stat_Name
                 ,P1.Serv_End_Dt
                 ,P1.Std_Prd_Lvl4_Id
                 ,P1.Owe_Suspend_Name
                 ,Pre_Active_Status1
                 ,P1.Oneway_Stop_Dt
                 ,P1.Twoway_Stop_Dt
                 ,(CASE WHEN P1.Std_Prd_Lvl4_Id IN (11010502,11020601,11010200,11010201,11010202,11010307)    
                        THEN ( CASE WHEN P1.Stat_Name = '不活动' THEN 0          
                   WHEN (Pre_Active_Status1 NOT IN ('预开户','移动即买即通') OR Pre_Active_Status1 IS NULL)     
                                         AND P1.Stat_Name <> '不活动'
                                         AND P1.Test_Flg = 0
                                         AND P1.Own_Flg = 0         
                                         AND NOT (COALESCE(P1.Owe_Suspend_Name,'-1') IN ('双向') 
                                                  AND P1.TwoWay_stop_Dt IS NOT NULL
                                                  AND P1.TwoWay_stop_Dt <= TO_DATE('20170608' ,  'YYYYMMDD')-62  
                                                  )
                                                 THEN 1                             
                                    ELSE 0
                                    END )
                         WHEN P1.Std_Prd_Lvl4_Id IN (11010501) 
                         THEN ( CASE WHEN P1.Stat_Name = '不活动' THEN 0          
                                 
                                   WHEN (Pre_Active_Status1 NOT IN ('预开户','移动即买即通') OR Pre_Active_Status1 IS NULL)
                                         AND P1.Stat_Name <> '不活动'
                                         AND P1.Test_Flg = 0
                                         AND NOT (P1.Own_Flg = 1 
                                                  AND COALESCE(P1.Owe_Suspend_Name,'-1') IN ('双向') 
                                                  AND P1.TwoWay_stop_Dt IS NOT NULL
                                                  AND P1.TwoWay_stop_Dt <= TO_DATE('20170608' ,  'YYYYMMDD')-62  
                                                  )
                                                 THEN 1                             
                                    ELSE 0
                                    END )
                             ELSE NULL
                   END) AS On_Serv_Flg      
                 
                 
                 
                 
                 
                 
                 
                 
                 
                 
                 
                 
                 
                 
                 
                 ,CASE WHEN P2.ASSET_ROW_ID IS NOT NULL THEN P2.BIL_FLG
                 ELSE 0
                 END AS BIL_FLG  
                   ,(CASE WHEN P1.Stat_Name = '不活动' THEN 0          
                        WHEN Pre_Active_Status1 = '预开户' THEN 0
                        WHEN Pre_Active_Status1 = '移动即买即通' THEN 0   
                        WHEN P16.On_Net_Flg='Y' THEN 1
                        WHEN P1.Std_Prd_Lvl3_Id IN (110202,110204) AND P16.On_Net_Flg IS NULL THEN 1
                        WHEN P16.On_Net_Flg='N' THEN 0 
                        WHEN CAST(TO_DATE(TO_CHAR(P1.Serv_Start_Dt) ,  'YYYYMMDD') AS CHAR(6))=CAST(TO_DATE('20170608' ,  'YYYYMMDD') AS CHAR(6)) THEN 1
                        ELSE 0
                        END)  AS On_Net_Flg				
                   ,P1.Twoway_Stop_Dt1  
                   ,P1.LATN_ID
                   ,P28.Last_Display_Area_Id
                   ,(CASE when SUBSTR(P17.VAL,LENGTH(P17.VAL)-3, 4)='Kbps' then P17.VAL
											 when SUBSTR(P17.VAL,LENGTH(P17.VAL)-3, 4)='Mbps' then CAST(CAST(SUBSTR(P17.VAL,1,LENGTH(P17.VAL)-4) AS INTEGER)*1024 AS VARCHAR(200))||'Kbps'
											 when SUBSTR(P17.VAL,LENGTH(P17.VAL),1)='M'       then CAST(CAST(SUBSTR(P17.VAL,1,LENGTH(P17.VAL)-1) AS INTEGER)*1024 AS VARCHAR(200))||'Kbps'
											 ELSE 'err'
											 END)  AS Speed
           FROM    MAIN_PRE_2_A                                 P1     
      LEFT JOIN  	 ZJBIC_2.OFR_MAIN_ASSET_FLG_A             			 P16           
             ON  	 P1.Asset_Row_Id=P16.Asset_Row_Id
            AND 	 P16.Bil_Month='201705'                    
      LEFT JOIN    TMP_SPEED_A P17
             ON    P1.ASSET_ROW_ID = P17.ASSET_ROW_ID     
      LEFT JOIN    ZJBIC_2.NEW_MARKET_AREA_NAME_A  P28
             ON    P1.Asset_Row_Id=P28.Asset_Row_Id  
      LEFT JOIN    NEW_BIL_FLG_A P2                 
      			 ON		 P1.ASSET_ROW_ID = P2.ASSET_ROW_ID
)
ORDER BY (Asset_Row_Id)
SEGMENTED BY HASH (Asset_Row_Id) ALL NODES KSAFE 0
;
CREATE TABLE
Time: First fetch (0 rows): 35561.988 ms. All rows formatted: 35562.012 ms
DELETE FROM KPI_2.KPI_ASSET_FLG_A_3
WHERE DATE_CD = TO_DATE('20170608' ,  'YYYYMMDD')
   OR (DATE_CD <= TO_DATE('20170608' ,  'YYYYMMDD') - 62 )
;
  OUTPUT  
----------
 42098168
(1 row)

Time: First fetch (1 row): 242106.940 ms. All rows formatted: 242106.980 ms
INSERT INTO KPI_2.KPI_ASSET_FLG_A_3
SELECT
Asset_Row_Id
,Date_Cd
,Bil_Flg
,On_Net_Flg
,On_Serv_Flg
,Latn_Id
,Last_Display_Area_Id
,Speed
,Std_Prd_Lvl4_Id
FROM MAIN_PRE_A
WHERE COALESCE(Pre_Active_Status1,'-1') NOT IN ('预开户','移动即买即通') 
order by Asset_Row_Id
;
  OUTPUT  
----------
 42098168
(1 row)

Time: First fetch (1 row): 9192.177 ms. All rows formatted: 9192.211 ms
CREATE LOCAL TEMP TABLE TMP_3G_TER_A_2 ON COMMIT PRESERVE ROWS
AS
(
SELECT    P1.Asset_Row_Id
          ,P1.Esn_Id
          ,P1.Register_Dt
          ,P1.Accs_Nbr
          ,P1.Equip_Id
          ,P1.Company    
          ,P1.Term_Model_Id
          ,P1.Ter_Model  
          ,P1.SHAOHAO_FLG
          ,p1.TERM_ROW_ID
          ,p1.Intelligent_Flg
          ,p1.TERM_TYPE
          ,P1.NEW_ESN_FLG
FROM      ZJBIC_2.OFR_TERM_USE_CUR_Z  P1
WHERE     LATN_ID = 10
)
ORDER BY (Asset_Row_Id)
SEGMENTED BY HASH (Asset_Row_Id) ALL NODES KSAFE 0
;
CREATE TABLE
Time: First fetch (0 rows): 2525.128 ms. All rows formatted: 2525.146 ms
CREATE LOCAL TEMP TABLE TMP_OFR_MAIN_ASSET_A_3_TMP ON COMMIT PRESERVE ROWS  
AS
(
select
P1.ASSET_ROW_ID
,P1.Telecom_Area_Id
FROM BSSDATA_2.OFR_MAIN_ASSET_HIST_A    P1
INNER JOIN DMN_2.CAG_COM_STD_PRD_LVL4  P12
ON P1.STD_PRD_LVL4_ID = P12.STD_PRD_LVL4_ID
AND P12.PRD_NAME='CDMA'
INNER join KPI_2.KPI_ASSET_FLG_A_3   P3
ON P1.ASSET_ROW_ID = P3.ASSET_ROW_ID
and P3.ON_SERV_FLG = 1
and P3.DATE_CD = TO_DATE('20170608'  , 'YYYYMMDD')  
WHERE P1.Start_Dt <= TO_DATE('20170608'  , 'YYYYMMDD')  
  and P1.End_Dt   >  TO_DATE('20170608'  , 'YYYYMMDD')  
  and P1.STAT_NAME <> '不活动'                
)
ORDER BY Asset_Row_Id,Telecom_Area_Id
SEGMENTED BY HASH (Asset_Row_Id) ALL NODES KSAFE 0
;
CREATE TABLE
Time: First fetch (0 rows): 262570.759 ms. All rows formatted: 262570.785 ms
CREATE LOCAL TEMP TABLE TMP_OFR_MAIN_ASSET_A_3 ON COMMIT PRESERVE ROWS
AS
(
select 
P1.ASSET_ROW_ID
,P1.Telecom_Area_Id
,MAX(CASE WHEN p2.Cdsc_Row_Id IN
            ( '1-18TGP-1'
             ,'1-18TGP-2'
             ,'1-18TGP-3'
             ,'1-18TGP-4'
             ,'1-1AAKH-1'
             ,'1-1AAKH-2'
             ,'1-1AAKH-3'
             ,'1-1ANI7-1'
             ,'1-1CD5L-1'
             ,'1-1CD5L-2'
             ,'1-1CD5L-3'
             ,'1-1CD5L-4'
             ,'1-1CD6D-1'
             ,'1-WCLGAV2'
             ,'1-WCLT15K'
             ,'1-WCMBDHI'
             ,'1-WCMBDHY'
             ,'1-WCN2528'
             ,'1-WCN584K'
             ,'1-WCN5850'
             ,'1-17F80-1'
            )
                 THEN 1 ELSE 0 END) AS Free_Flg              
            ,MAX(CASE WHEN P2.Cdsc_Row_Id='1-17F80-2' THEN 1 ELSE 0 END) AS Corp_Pay_Flg          
            ,MAX(CASE WHEN P2.Cdsc_Row_Id='1-19849-1' THEN 1 ELSE 0 END) AS Test_Flg
FROM TMP_OFR_MAIN_ASSET_A_3_TMP   P1
LEFT join BSSDATA_2.OFR_ASSET_CDSC_HIST_A   P2
ON P1.ASSET_ROW_ID = P2.ASSET_ROW_ID
and P2.Start_Dt <= TO_DATE('20170608'  , 'YYYYMMDD') 
and P2.End_Dt   >  TO_DATE('20170608'  , 'YYYYMMDD')
and P2.STAT_NAME = '使用中'
AND P2.Cdsc_Row_Id IN
            ( '1-18TGP-1'
             ,'1-18TGP-2'
             ,'1-18TGP-3'
             ,'1-18TGP-4'
             ,'1-1AAKH-1'
             ,'1-1AAKH-2'
             ,'1-1AAKH-3'
             ,'1-1ANI7-1'
             ,'1-1CD5L-1'
             ,'1-1CD5L-2'
             ,'1-1CD5L-3'
             ,'1-1CD5L-4'
             ,'1-1CD6D-1'
             ,'1-WCLGAV2'
             ,'1-WCLT15K'
             ,'1-WCMBDHI'
             ,'1-WCMBDHY'
             ,'1-WCN2528'
             ,'1-WCN584K'
             ,'1-WCN5850'
             ,'1-17F80-1'
             ,'1-17F80-2'
             ,'1-19849-1'
            )
GROUP BY P1.ASSET_ROW_ID 
,P1.Telecom_Area_Id
)
ORDER BY Asset_Row_Id,Telecom_Area_Id
SEGMENTED BY HASH (Asset_Row_Id) ALL NODES KSAFE 0
;
CREATE TABLE
Time: First fetch (0 rows): 1907.451 ms. All rows formatted: 1907.471 ms
CREATE LOCAL TEMP TABLE TMP_3G_TER_A ON COMMIT PRESERVE ROWS
AS
(
select 
P1.*
,P2.Telecom_Area_Id
FROM TMP_3G_TER_A_2   P1
INNER join TMP_OFR_MAIN_ASSET_A_3  P2
ON P1.ASSET_ROW_ID = P2.ASSET_ROW_ID
and P2.Free_Flg = 0
and P2.Corp_Pay_Flg = 0
and P2.Test_Flg = 0
)
ORDER BY Asset_Row_Id,Telecom_Area_Id
SEGMENTED BY HASH (Asset_Row_Id) ALL NODES KSAFE 0
;
CREATE TABLE
Time: First fetch (0 rows): 3996.619 ms. All rows formatted: 3996.639 ms
DELETE FROM KPI_2.KPI_ASSET_TER_A_3
WHERE (DATE_CD = TO_DATE('20170608'  , 'YYYYMMDD') or DATE_CD < TO_DATE('20170608'  , 'YYYYMMDD') - 62 )
;
 OUTPUT  
---------
 2500840
(1 row)

Time: First fetch (1 row): 285.307 ms. All rows formatted: 285.343 ms
INSERT INTO KPI_2.KPI_ASSET_TER_A_3
(
Date_Cd
,Esn_Id
,Esn_New_Dt
,Asset_Row_Id
,Accs_Nbr
,Register_Dt
,Telecom_Area_Id
,Equip_Id
,Shaohao_Flg
,Term_Row_Id
,Intelligent_Flg
,Company
,Ter_Model
,Term_Type
,Latn_Id
)
select 
TO_DATE('20170608'  , 'YYYYMMDD')
,P1.Esn_Id
,CASE WHEN NEW_ESN_FLG = 1 THEN TO_DATE('20170608'  , 'YYYYMMDD') else P3.Esn_New_Dt END 
,P1.Asset_Row_Id
,P1.Accs_Nbr
,P1.Register_Dt
,TO_NUMBER(P1.Telecom_Area_Id)
,P1.Equip_Id
,P1.Shaohao_Flg
,P1.Term_Row_Id
,P1.Intelligent_Flg
,P1.Company
,P1.Ter_Model
,P1.Term_Type
,10
FROM TMP_3G_TER_A   P1
LEFT join KPI_2.KPI_ASSET_TER_A_3  p3
ON P1.ESN_ID = P3.ESN_ID
and p3.DATE_CD = TO_DATE('20170608'  , 'YYYYMMDD') - 1 
and LATN_ID = 10
;
 OUTPUT  
---------
 2500840
(1 row)

Time: First fetch (1 row): 5794.048 ms. All rows formatted: 5794.083 ms
CREATE LOCAL TEMP table ORDI_A_SPRD_MC ON COMMIT PRESERVE ROWS
AS(
SELECT     P5.Order_Item_Row_Id
             ,P5.Std_Prd_Lvl4_Id
             ,P8.Std_Prd_Lvl4_Name
     FROM    BSSDATA_2.EVT_ORDI_HIST_A    P5
INNER JOIN   DMN_2.CAG_COM_STD_PRD_LVL4   P8 
       ON    P5.Std_Prd_Lvl4_Id = P8.Std_Prd_Lvl4_Id 
      WHERE  P8.PRD_ID IN('40','60','50','10','70')    
      AND    P5.ETL_DT =  TO_DATE('20170608'  , 'YYYYMMDD')    
)
ORDER BY Order_Item_Row_Id,Std_Prd_Lvl4_Id
SEGMENTED BY HASH (Order_Item_Row_Id) ALL NODES KSAFE 0
;
CREATE TABLE
Time: First fetch (0 rows): 567.867 ms. All rows formatted: 567.889 ms
CREATE LOCAL TEMP table ORDI_A_ALL_PRO ON COMMIT PRESERVE ROWS
AS(
SELECT     P1.Order_Item_Row_Id
             ,P1.Order_Row_Id
             ,P1.Stat_Name
             ,P1.CPRD_ROW_ID
             ,P1.Cpl_Dt
             ,P1.Channel_Name
             ,P1.Channel_Sub_Name
             ,P1.Sales_Emp_Id
             ,P1.Exch_Id
             ,P1.Telecom_Area_Id
             ,COALESCE(P1.Discon_Reason,'')||
                      CASE WHEN P1.Discon_Reason IS NOT NULL AND P1.Discon_Reason_Class IS NOT NULL THEN '--' 
                      ELSE '' END||
                      COALESCE(P1.Discon_Reason_Class,'') AS Discon_Reason    
             ,P1.CAcct_Row_Id
             ,P1.Root_Order_Item_Id
             ,P1.Latn_Id
             ,P1.Asset_Integ_Id
             ,P1.Last_Upd_Dt            
             ,(CASE P1.Action_Type_Name  WHEN '新增' THEN 'I'
                                         WHEN '拆机' THEN 'O'
                                         ELSE NULL
               END)  AS IOM_Flg
             ,P1.Pre_Active_Status
             ,P1.Prom_Asset_Integ_Id                
	           ,P2.CPRD_NAME 
             ,P2.Cprd_Id 
             ,P5.Std_Prd_Lvl4_Id
             ,P5.Std_Prd_Lvl4_Name
             ,P1.Telecom_Area_Name
     FROM    BSSDATA_2.EVT_ORDI_HIST_A  P1
INNER JOIN   BSSDATA_2.OFR_CPRD                    P2
       ON    P1.CPRD_ROW_ID = P2.CPrd_Row_Id
      AND    P2.Main_Child_Prd_Flg = 1
INNER JOIN   ORDI_A_SPRD_MC               P5                        
       ON    P1.Order_Item_Row_Id = P5.Order_Item_Row_Id
    WHERE    P1.ETL_DT = TO_DATE('20170608'  , 'YYYYMMDD')  
      AND    P1.Action_Type_Name IN    ('新增','拆机') 
      AND    P1.Stat_Name = '完成'  
      AND    P1.Order_Item_Row_Id IS NOT NULL
      AND    P1.Order_Row_Id      IS NOT NULL
      AND    P1.Telecom_Area_Id   IS NOT NULL
      AND    P1.Latn_Id           IS NOT NULL     
)
ORDER BY Order_Item_Row_Id,CPRD_ROW_ID
SEGMENTED BY HASH (Order_Item_Row_Id) ALL NODES KSAFE 0
;
CREATE TABLE
Time: First fetch (0 rows): 1552.720 ms. All rows formatted: 1552.768 ms
CREATE LOCAL TEMP table ASSET_INFO_DAILY_TMP ON COMMIT PRESERVE ROWS
AS(
SELECT 		Asset_Integ_Id
            ,Asset_Row_Id
            ,Root_Asset_Row_Id
            ,Asset_Id FROM (
SELECT      ROW_NUMBER() OVER (PARTITION BY Asset_Integ_Id ORDER BY Stat_Name DESC,Start_Dt DESC) AS Q_RANK
			,Asset_Integ_Id				  
            ,Asset_Row_Id
            ,Asset_Row_Id AS Root_Asset_Row_Id
            ,Asset_Id
 FROM       BSSDATA_2.OFR_MAIN_ASSET_HIST_A
WHERE       Start_Dt >= TO_DATE('20170608'  , 'YYYYMMDD')
  and       END_DT > TO_DATE('20170608'  , 'YYYYMMDD') - 10 
  and       Asset_Integ_Id IS not NULL
) Y  WHERE Q_RANK    = 1   
)
ORDER BY Asset_Integ_Id,Asset_Row_Id,Root_Asset_Row_Id,Asset_Id
SEGMENTED BY HASH (Asset_Integ_Id) ALL NODES KSAFE 0
;
CREATE TABLE
Time: First fetch (0 rows): 1651.240 ms. All rows formatted: 1651.263 ms
CREATE LOCAL TEMP table ORDI_A_VALID_CARD_TMP ON COMMIT PRESERVE ROWS
AS(
SELECT     
               P1.Order_Item_Row_Id
              ,P1.Order_Row_Id
              ,P1.Stat_Name
              ,P1.Last_Upd_Dt
              ,P1.CPRD_ROW_ID
              ,P1.Cpl_Dt       
              ,P1.Channel_Name
              ,P1.Channel_Sub_Name
              ,P1.Sales_Emp_Id
              ,P1.Telecom_Area_Id
              ,P1.Discon_Reason
              ,P1.CAcct_Row_Id
              ,P1.Root_Order_Item_Id
              ,P1.Latn_Id
              ,P1.Asset_Integ_Id
              ,P1.IOM_Flg
              ,P1.Std_Prd_Lvl4_Id
              ,P1.Std_Prd_Lvl4_Name  
              ,P2.Asset_Row_Id
              ,P2.Root_Asset_Row_Id 
              ,P2.Asset_Id           
              ,P1.Pre_Active_Status   
              ,P1.Prom_Asset_Integ_Id                           
	            ,P1.CPRD_NAME 
              ,P1.Cprd_Id           
              ,P1.Telecom_Area_Name
              ,P28.Last_Display_Area_Id
              ,P28.Last_Display_Area_Name
     FROM     ORDI_A_ALL_PRO                  P1
LEFT JOIN     ASSET_INFO_DAILY_TMP         P2           
       ON     P1.Asset_Integ_Id = P2.Asset_Integ_Id
LEFT JOIN     ZJBIC_2.NEW_MARKET_AREA_NAME_A  P28
      ON      P2.Asset_Row_Id=P28.Asset_Row_Id    
)
ORDER BY ASSET_ROW_ID, Order_Item_Row_Id,Asset_Integ_Id
SEGMENTED BY HASH (ASSET_ROW_ID) ALL NODES KSAFE 0
;
CREATE TABLE
Time: First fetch (0 rows): 961.283 ms. All rows formatted: 961.304 ms
CREATE LOCAL TEMP table ASSET_AGENT_A ON COMMIT PRESERVE ROWS
AS(
SELECT       P0.ASSET_ROW_ID
            ,P1.Agent_Id     AS  AGENT_POINT_ID
            ,P2.AGENT_POINT_NAME
            ,P0.Dept_Row_Id
            ,P1.Dept_Name
     FROM   BSSDATA_2.OFR_MAIN_ASSET_HIST_A  P0 
LEFT JOIN   BSSDATA_2.PAR_DEPT                           P1
       ON   P0.Dept_Row_Id=P1.Dept_Row_Id
LEFT JOIN   BSSDATA_2.MKT_AGENT_POINT_Z      	   P2
       ON   P1.AGENT_ID=P2.AGENT_POINT_ID 
    WHERE   P0.End_Dt = DATE'3000-12-31'
      AND   P2.End_Dt = DATE'3000-12-31'
)
ORDER BY ASSET_ROW_ID,Dept_Row_Id,AGENT_POINT_ID
SEGMENTED BY HASH (ASSET_ROW_ID) ALL NODES KSAFE 0
;
CREATE TABLE
Time: First fetch (0 rows): 54542.842 ms. All rows formatted: 54542.892 ms
CREATE LOCAL TEMP table ASSET_MARKET_A ON COMMIT PRESERVE ROWS
AS(
SELECT       P7.Asset_Row_Id
            ,P7.Area_Id
            ,P7.Start_Dt
            ,P14.Area_Name
     FROM   BSSDATA_2.MKT_ASSET_CLAIM_A    P7
LEFT JOIN   BSSDATA_2.OFR_MKT_CHANNEL_A          P14     
       ON   P7.Area_Id = P14.Area_Id 
    WHERE   P7.Start_Dt<=TO_DATE('20170608'  , 'YYYYMMDD')
      AND   P7.End_Dt>TO_DATE('20170608'  , 'YYYYMMDD')
)
ORDER BY ASSET_ROW_ID,Area_Id 
SEGMENTED BY HASH (ASSET_ROW_ID) ALL NODES KSAFE 0
;
CREATE TABLE
Time: First fetch (0 rows): 4008.512 ms. All rows formatted: 4008.572 ms
CREATE LOCAL TEMP table ORDI_A_PRE1 ON COMMIT PRESERVE ROWS
AS(
SELECT  
                   P0.Order_Item_Row_Id
                  ,P0.Order_Row_Id           
                  ,P0.Stat_Name          
                  ,P0.Last_Upd_Dt        
                  ,P0.Cpl_Dt                 
                  ,P0.Sales_Emp_Id                  
                  ,P0.Telecom_Area_Id    
                  ,P0.Discon_Reason      
                  ,P0.CAcct_Row_Id       
                  ,P0.Root_Order_Item_Id 
                  ,P0.Latn_Id            
                  ,P0.Asset_Integ_Id          
                  ,COALESCE(P7.Area_Id,-1) AS Area_Id  
	                ,P7.Start_Dt
                  ,P0.CPRD_NAME 
                  ,P0.Cprd_Id
                  ,P0.Cprd_Row_Id
                  ,COALESCE(P7.Area_Name,'err') AS Area_Name                             
                  ,P0.Telecom_Area_Name                     
                  ,P0.Asset_Row_Id                 
                  ,P18.Agent_Point_Id
                  ,P18.Agent_Point_Name 
                  ,P0.Last_Display_Area_Id
                  ,P0.Last_Display_Area_Name
         FROM     ORDI_A_VALID_CARD_TMP                  P0 
    LEFT JOIN     ASSET_MARKET_A                         P7
           ON     P0.Asset_Row_Id = P7.Asset_Row_Id      
    LEFT JOIN     ASSET_AGENT_A                          p18
           ON     P0.Asset_Row_Id = P18.ASSET_ROW_ID                                  
)
ORDER BY ASSET_ROW_ID,Order_Item_Row_Id,Order_Row_Id
SEGMENTED BY HASH (ASSET_ROW_ID) ALL NODES KSAFE 0
;
CREATE TABLE
Time: First fetch (0 rows): 17643.757 ms. All rows formatted: 17643.775 ms
CREATE LOCAL TEMP table ORDI_A_PRE3_ORDER ON COMMIT PRESERVE ROWS
AS(
SELECT    
                   P.Order_Item_Row_Id
                  ,(CASE   
                        WHEN P1.Instant_Flg='即买即通补录'   THEN 'Y'
                        WHEN P1.Instant_Flg ='移动即买即通'  THEN 'C'                 
                        WHEN P.Pre_Active_Status='移动即买即通'     THEN 'C'     
                        WHEN P.Pre_Active_Status='预开户'     THEN 'C'
                        ELSE 'N'
                        END)AS Instant_Flg   
                  ,P1.APPLY_DT  Create_Dt 
                  ,P1.Order_Id  
                  ,P1.CEmployee_Row_Id   
                  ,P1.Sales_Telecom_Area_ID                   
                  ,P.IOM_Flg
                  ,P.Std_Prd_Lvl4_Id
                  ,P.Std_Prd_Lvl4_Name 
                  ,P1.Pay_Mode_Name
                  ,P1.Pre_Sales_Emp_Id
                  ,P1.Pre_Order_Id   
                  ,P.Asset_Row_Id 
                  ,P.Prom_Asset_Integ_Id                 
                 ,P1.CCust_Row_Id             
                 ,P.Asset_Integ_Id    
                 ,P.Last_Display_Area_Id
                 ,P.Last_Display_Area_Name
         FROM     ORDI_A_VALID_CARD_TMP                  P 
   INNER JOIN     BSSDATA_2.EVT_ORDER_HIST_A           P1       
           ON     P.Order_Row_Id = P1.Order_Row_Id                
)
ORDER BY Asset_Integ_Id,Asset_Row_Id
SEGMENTED BY HASH (Asset_Integ_Id) ALL NODES KSAFE 0
;
CREATE TABLE
Time: First fetch (0 rows): 1583.584 ms. All rows formatted: 1583.599 ms
CREATE LOCAL TEMP table ORDI_A_3_PRE3 ON COMMIT PRESERVE ROWS
AS(
SELECT    
                   P.Order_Item_Row_Id
                  ,P.Instant_Flg   
                  ,P.Create_Dt      
                  ,P.ASSET_INTEG_ID
                  
                  
                  
                  
                  
                  ,P11.CEmployee_Id          
                  ,P.Order_Id                          
                  ,P11.CEmployee_Name   
                  ,P.Sales_Telecom_Area_ID                   
                  
                  ,P.CCust_Row_Id   
                  ,P.IOM_Flg
                  ,P.Std_Prd_Lvl4_Id
                  ,P.Std_Prd_Lvl4_Name 
                  ,P.Asset_Row_Id 
                  ,P.Last_Display_Area_Id
                  ,P.Last_Display_Area_Name             
          FROM    ORDI_A_PRE3_ORDER                  P              
    LEFT JOIN     BSSDATA_2.Par_Cemployee_Hist                    P11
           ON     P.CEmployee_Row_Id = P11.CEmployee_Row_Id
          AND     P11.Start_Dt <= TO_DATE('20170608'  , 'YYYYMMDD')
          AND     P11.End_Dt   >  TO_DATE('20170608'  , 'YYYYMMDD')            
    
    
    
    
        WHERE     COALESCE(P.Instant_Flg,'Y') <> 'C'          
)
ORDER BY Order_Item_Row_Id,ASSET_INTEG_ID
SEGMENTED BY HASH (Order_Item_Row_Id) ALL NODES KSAFE 0
;
CREATE TABLE
Time: First fetch (0 rows): 855.432 ms. All rows formatted: 855.452 ms
CREATE LOCAL TEMP table ORDI_A_PRE3 ON COMMIT PRESERVE ROWS
AS(
SELECT    
                   P.Order_Item_Row_Id
                  ,P.Instant_Flg   
                  ,P.Create_Dt      
                  ,P.ASSET_INTEG_ID
                  ,P21.Sales_Channel_Name
                  ,P21.Sales_Channel_Sub_Name
                  ,P21.Mkt_Channel_Name
                  ,P21.Mkt_Channel_Sub_Name  
                  ,P21.Channel_Lvl2_Name      AS MKt_Channel_Lvl2_Name        
                  ,P.CEmployee_Id          
                  ,P.Order_Id                          
                  ,P.CEmployee_Name   
                  ,P.Sales_Telecom_Area_ID                  
                  ,P.CCust_Row_Id   
                  ,P.IOM_Flg
                  ,P.Std_Prd_Lvl4_Id
                  ,P.Std_Prd_Lvl4_Name 
                  ,P.Asset_Row_Id 
                  ,P.Last_Display_Area_Id
                  ,P.Last_Display_Area_Name             
          FROM    ORDI_A_3_PRE3                  P                                              
    LEFT JOIN     ZJBIC_2.ORDER_SALE_NAME_ALL_A            P21                 
           ON     P.ASSET_ROW_ID=P21.ASSET_ROW_ID           
)
ORDER BY Order_Item_Row_Id,Asset_Row_Id
SEGMENTED BY HASH (Order_Item_Row_Id) ALL NODES KSAFE 0
;
CREATE TABLE
Time: First fetch (0 rows): 50549.431 ms. All rows formatted: 50549.453 ms
CREATE LOCAL TEMP table ORDI_A_PRE_ALL ON COMMIT PRESERVE ROWS
AS(
SELECT         
                   P.Asset_Row_Id                   AS        Asset_Row_Id
                  ,P.Asset_Integ_Id                 AS        Asset_Integ_Id
                  ,P2.Order_Item_Row_Id              AS        Ordi_Row_Id                    
                  ,P.Order_Row_Id                   AS        Order_Row_Id                 
                  ,P2.IOM_Flg                       AS        IOM_Flg    
                  ,P.Cprd_Row_Id                    AS        Cprd_Row_Id
                  ,P.CPRD_NAME                      AS        CPrd_Name
                  ,P2.Std_Prd_Lvl4_Name             AS        Std_Prd_Lvl4_Name
                  ,P2.Std_Prd_Lvl4_Id               AS        Std_Prd_Lvl4_Id
                  ,P2.CCust_Row_Id                  AS        CCust_Row_Id
                  ,P.Telecom_Area_Id                AS        Telecom_Area_Id
                  ,P.Telecom_Area_Name              AS        Telecom_Area_Name
                  ,P.Area_Id                        AS        Area_Id
                  ,P.Area_Name                      AS        Area_Name
                  ,P2.Last_Display_Area_Id          AS        Last_Display_Area_Id   
                  ,P2.Last_Display_Area_Name        AS        Last_Display_Area_Name  
                  ,P.Agent_Point_Id                 AS        Agent_Point_Id
                  ,P.Agent_Point_Name               AS        Agent_Point_Name 
                  ,P2.Create_Dt                     AS        Apply_Dt                                            
                  ,P.Cpl_Dt                         AS        Cpl_Dt                     
                  ,P.Stat_Name                      AS        Stat_Name                 
                  ,P2.Instant_Flg                   AS        Pre_Flg                      
                  ,P2.MKt_Channel_Lvl2_Name         AS        MKt_Channel_Lvl2_Name                     
                  ,P2.Sales_Channel_Name            AS        Sales_Channel_Lvl2_Name   
                  ,P2.CEmployee_Id                  AS        Sales_Employee_Id                                                                                           
                  ,P2.CEmployee_Name                AS        Sales_Employee_Name 
                  ,P.Sales_Emp_Id                   AS        Mkt_Employee_Id 
                  ,'-1                  '           AS        Mkt_Employee_Name
                  ,P.Discon_Reason                  AS        Discon_Reason
                  ,P.Latn_Id                        AS        Latn_Id                                                              
         FROM     ORDI_A_PRE3                            P2 


    LEFT JOIN     ORDI_A_PRE1                            P    
           ON     P2.Order_Item_Row_Id = P.Order_Item_Row_Id          
        WHERE     P.Order_Item_Row_Id IS NOT NULL
          AND     P.Order_Row_Id IS NOT NULL
          AND     P2.IOM_Flg IS NOT NULL
          AND     P.Stat_Name IS NOT NULL
          AND     P2.Create_Dt IS NOT NULL
          AND     P2.Std_Prd_Lvl4_Name IS NOT NULL
          AND     P.CPRD_NAME IS NOT NULL
          AND     P.Telecom_Area_Name IS NOT NULL
          AND     P2.Std_Prd_Lvl4_Id IS NOT NULL
          AND     P.Cprd_Row_Id IS NOT NULL
          AND     P.Telecom_Area_Id IS NOT NULL
          AND     Order_Id IS NOT NULL
          AND     P.Asset_Integ_Id IS NOT NULL
          AND     P2.Instant_Flg IS NOT NULL
          AND     P2.CCust_Row_Id IS NOT NULL
          AND     P.Latn_Id IS NOT NULL       
)
ORDER BY Ordi_Row_Id,Order_Item_Row_Id
SEGMENTED BY HASH (Ordi_Row_Id) ALL NODES KSAFE 0
;
ERROR 2671:  Column reference "Order_Item_Row_Id" is ambiguous
run_bteq_command() = 0
